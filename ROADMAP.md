# Дорожная карта: WB Repricer (PriceForge)

**Дата создания:** 2026-02-19
**Последнее обновление:** 2026-02-21
**Подход:** Итеративная разработка, MVP-first

---

## Обзор фаз

```
Фаза 0: Подготовка инфраструктуры          ████████████████████  DONE
Фаза 1: MVP — ядро репрайсера              ████████░░░░░░░░░░░░  Sprint 1.2 done
Фаза 2: Аналитика и дашборды               ░░░░░░░░░░░░░░░░░░░░
Фаза 3: Стратегии и автоматика             ░░░░░░░░░░░░░░░░░░░░
Фаза 4: Полировка и расширение             ░░░░░░░░░░░░░░░░░░░░
```

---

## Фаза 0: Подготовка инфраструктуры — DONE (2026-02-19)

**Цель:** Развернуть сервер, настроить окружение, подключить WB API

### Задачи

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 0.1 | Арендовать VPS | ✅ | 45.12.72.202, Ubuntu 24.04 |
| 0.2 | Docker + Docker Compose | ✅ | pf-backend, pf-postgres, pf-redis, nginx |
| 0.3 | SSL | ✅ | sslip.io (https://45-12-72-202.sslip.io) |
| 0.4 | Структура проекта | ✅ | FastAPI + React + Docker configs |
| 0.5 | WB API подключение | ✅ | API-ключ шифруется AES-256, все эндпоинты работают |
| 0.6 | Схема БД | ✅ | Прямые SQL миграции (без Alembic пока) |
| 0.7 | Git + CI/CD | ✅ | GitHub sergeigeyn/WB-Repricer, deploy.sh |
| 0.8 | Frontend деплой | ✅ | Vercel (wb-repricer.vercel.app), автодеплой |

---

## Фаза 1: MVP — Ядро репрайсера

**Цель:** Минимально работающий продукт с 4 ключевыми функциями из требований заказчика

### Sprint 1.1: Сбор данных и каталог товаров — DONE (2026-02-20)

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.1.1 | WB Data Collector | ✅ | `collect_all()`: товары, цены, остатки, заказы, комиссии, логистика, хранение |
| 1.1.2 | Каталог товаров | ✅ | Таблица Ant Design с фото, артикулами, группированными колонками |
| 1.1.3 | Загрузка себестоимости | ✅ | Inline-редактирование + Excel/CSV импорт |
| 1.1.4 | Юнит-экономика | ✅ | Полная формула: себестоимость + налог + комиссия + тариф + логистика + хранение + реклама + прочие |
| 1.1.5 | Конструктор тарифов | ✅ | Прочие расходы: фиксированные (₽) + процентные (%) |
| 1.1.6 | Авторизация | ✅ | JWT, роли admin/manager/viewer |

**Что собирает Data Collector:**
- Карточки товаров — Content API (курсорная пагинация)
- Цены/скидки — Prices API → PriceSnapshot
- Остатки — Statistics API (FBO+FBS)
- Заказы/возвраты — Statistics API → SalesDaily (агрегация по дням MSK)
- Комиссии — Common API (по категориям)
- Логистика/СПП — Financial Report API v5 (rrdid-пагинация)
- Хранение — Paid Storage API (async task, 8-day chunks)

### Sprint 1.2: MVP-функция #1 — Прогноз маржи при входе в акцию — DONE (2026-02-21)

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.2.1 | Сбор акций из WB API | ✅ | Calendar API: 4 метода, auto-sync в `collect_all()`, 158 акций получено |
| 1.2.2 | Расчёт маржинальности | ✅ | `calculate_promo_margin()`: текущая vs акционная маржа (₽ и %) |
| 1.2.3 | UI: экран акций | ✅ | Список акций (Tabs: Активные/Будущие/Завершённые) + детали с товарами |
| 1.2.4 | Автовход/автовыход | ⏳ | Отложено — будет в будущем спринте |
| 1.2.5 | История акций | ⏳ | Отложено — будет в будущем спринте |

**Ключевые решения Sprint 1.2:**
- Calendar API доступен через токен "Цены и скидки" (не отдельный "Календарь")
- Два источника: автосинхронизация через API + ручной Excel/CSV импорт
- Rate limit: `asyncio.sleep(1.5)` между вызовами номенклатур (10 req / 6 sec)
- 422 обработка: некоторые акции не поддерживают запрос номенклатур
- Двойной fetch номенклатур: `inAction=true` + `inAction=false` для полной картины

**UI экрана акций:**
- Список: название, тип, период, статус (Tag), товаров, средняя маржа, выгодных
- Детали: карточка акции + таблица товаров с группированными колонками
- Группы: Товар (фото/артикул/название), Цены (текущая/акционная/скидка), Маржа (тек₽/%/акц₽/%), Статус
- Кнопки: "Войти выгодным" (margin > 0), "Пропустить убыточные" (margin ≤ 0)
- Фильтры: Все/Выгодные/Убыточные/В акции
- Загрузка акции из Excel/CSV (кнопка + модальное окно)

---

### Sprint 1.3: MVP-функция #2 — Защита от out-of-stock

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.3.1 | Мониторинг остатков | ⏳ | Сбор остатков по складам, расчёт скорости убытия |
| 1.3.2 | Стратегия Out-of-Stock Protection | ⏳ | Автоповышение цены при остатках < порога |
| 1.3.3 | Настройка порогов | ⏳ | UI для настройки min остатка, шага повышения |
| 1.3.4 | Telegram-алерт | ⏳ | Уведомление когда остатки критично низкие |

### Sprint 1.4: MVP-функция #3 — Акционный бустинг (медианная цена)

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.4.1 | Расчёт медианной цены | ⏳ | Анализ текущей медианы WB для товара |
| 1.4.2 | Стратегия Promotion Booster | ⏳ | Плавное повышение базовой цены перед акцией |
| 1.4.3 | Настройка стратегии | ⏳ | Сроки повышения, шаг, целевая медиана |
| 1.4.4 | Визуализация | ⏳ | График текущей vs целевой медианной цены |

### Sprint 1.5: MVP-функция #4 — Ценообразование по скорости продаж

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.5.1 | Расчёт скорости продаж | ⏳ | Скорость 7д / скорость 14д = коэффициент тренда |
| 1.5.2 | Динамика корзин и заказов | ⏳ | Корзины/заказы за день vs за 7 дней |
| 1.5.3 | Стратегия Sales Velocity | ⏳ | Коррекция цены на основе тренда |
| 1.5.4 | Настройка стратегии | ⏳ | Пороги изменения, шаг цены, min/max маржа |
| 1.5.5 | Логирование изменений | ⏳ | Журнал: что изменилось, почему, когда |

### Sprint 1.6: Управление ценами

| # | Задача | Статус | Детали |
|---|--------|--------|--------|
| 1.6.1 | Обновление цен через WB API | ⏳ | Установка цен и скидок через API |
| 1.6.2 | Dry run (предпросмотр) | ⏳ | Показать что изменится БЕЗ применения |
| 1.6.3 | Откат (undo) | ⏳ | Возврат цен к состоянию на дату |
| 1.6.4 | Массовое обновление | ⏳ | Загрузка Excel для массового изменения |
| 1.6.5 | Расписание | ⏳ | Celery Beat: запуск стратегий 2р/день |

### Результат Фазы 1 (MVP)
- Каталог товаров с юнит-экономикой
- 4 рабочие стратегии (акции, out-of-stock, бустинг, скорость продаж)
- Автоматическое изменение цен 2р/день
- Прогноз маржи при входе в акции
- Журнал изменений, dry run, откат
- Telegram-алерты
- Авторизация с ролями

---

## Фаза 2: Аналитика и дашборды

**Цель:** Глубокая аналитика по образцу Indeepa, визуальные дашборды

### Sprint 2.1: Аналитика карточки товара

| # | Задача | Детали |
|---|--------|--------|
| 2.1.1 | График 1: Динамика цен | СПП%, цена с СПП, макс. промо-цена |
| 2.1.2 | График 2: Основные параметры | Выкуп%, скорость 14д, бустинг, оборачиваемость, остатки |
| 2.1.3 | График 3: Цена акции | Цена артикула vs цены акций |
| 2.1.4 | График 4: Цена-заказы | Цена, СПП-цена, заказы шт., отмены |
| 2.1.5 | Борд: Заказы по ценам (до СПП) | Гистограмма |
| 2.1.6 | Борд: Заказы по ценам (с СПП) | Гистограмма |
| 2.1.7 | Борд: Пиковые часы | Распределение заказов по часам |
| 2.1.8 | Борд: Пиковые дни | Распределение заказов по дням недели |

### Sprint 2.2: Главный дашборд

| # | Задача | Детали |
|---|--------|--------|
| 2.2.1 | Виджет: общая прибыль | За произвольный период |
| 2.2.2 | Виджет: изменения цен | Количество за день |
| 2.2.3 | Виджет: низкая маржа | Товары с критичной маржинальностью |
| 2.2.4 | Виджет: активные акции | Текущие акции и их P&L |
| 2.2.5 | Виджет: без стратегии | Товары без привязанной стратегии |
| 2.2.6 | Утренний отчёт | Заказы, маржа, выручка, отмены, выкупы за период |
| 2.2.7 | Отчёт об ошибках | Товары с проблемами |

### Sprint 2.3: Отчёты и экспорт

| # | Задача | Детали |
|---|--------|--------|
| 2.3.1 | P&L за период | Прибыли/убытки |
| 2.3.2 | ABC/XYZ-анализ | Классификация товаров |
| 2.3.3 | Рейтинг по маржинальности | Сортируемая таблица |
| 2.3.4 | Эффективность акций | ROI участия в акциях |
| 2.3.5 | Влияние цены на продажи | До/после изменения |
| 2.3.6 | Прогноз продаж и выручки | На основе тренда |
| 2.3.7 | Экспорт в Excel/CSV | Все отчёты |
| 2.3.8 | Разрезы аналитики | Склады, регионы, бренды, категории, менеджеры |

---

## Фаза 3: Стратегии и автоматика

**Цель:** Расширенные стратегии, конкуренты, комбинирование

### Sprint 3.1: Мониторинг конкурентов

| # | Задача | Детали |
|---|--------|--------|
| 3.1.1 | Добавление конкурентов | Ручной ввод артикулов |
| 3.1.2 | Сбор цен конкурентов | Парсинг/API, история |
| 3.1.3 | Антидемпинг-фильтр | Игнорирование подозрительно низких цен |
| 3.1.4 | Автообнаружение конкурентов | По категории (желательно) |
| 3.1.5 | Стратегия: следование за конкурентом | Дешевле/на уровне/дороже на X ₽/% |

### Sprint 3.2: Дополнительные стратегии

| # | Задача | Детали |
|---|--------|--------|
| 3.2.1 | Целевая маржа (floor) | Минимальный порог маржинальности |
| 3.2.2 | Диапазон цен | Min/max на товар |
| 3.2.3 | Реакция на спрос | ↑/↓ от динамики спроса |
| 3.2.4 | По расписанию | Разные цены будни/выходные |
| 3.2.5 | Товары-локомотивы | Агрессивная стратегия с min-порогом |
| 3.2.6 | Комбинирование стратегий | Несколько стратегий на товар |
| 3.2.7 | Приоритеты стратегий | Конфликт-резолюция |

### Sprint 3.3: A/B-тестирование и уведомления

| # | Задача | Детали |
|---|--------|--------|
| 3.3.1 | A/B-тест цен | Эксперименты с лимитом ±X% |
| 3.3.2 | Дайджест ежедневный | Telegram: утренний отчёт |
| 3.3.3 | Дайджест еженедельный | Telegram: недельные тренды |
| 3.3.4 | Гибкие триггеры уведомлений | Настраиваемые условия алертов |

---

## Фаза 4: Полировка и расширение

**Цель:** Кастомизация, интеграции, производительность

### Sprint 4.1: Кастомизация UI

| # | Задача | Детали |
|---|--------|--------|
| 4.1.1 | Настраиваемый дашборд | Drag-and-drop виджеты |
| 4.1.2 | Пользовательские колонки | Выбор колонок в таблицах |
| 4.1.3 | Сохранение фильтров | Именованные предустановки |
| 4.1.4 | Тёмная тема | Опционально |

### Sprint 4.2: Интеграции

| # | Задача | Детали |
|---|--------|--------|
| 4.2.1 | Google Sheets экспорт | Автоматическая выгрузка отчётов |
| 4.2.2 | Бэкап на S3/внешнее хранилище | Гибрид облако + локальный |
| 4.2.3 | Учёт WB-кошелька | В расчёте финальной цены |
| 4.2.4 | Комплекты (bundles) | Автопересчёт цены комплекта |

### Sprint 4.3: Оптимизация

| # | Задача | Детали |
|---|--------|--------|
| 4.3.1 | Оптимизация запросов БД | Индексы, кеширование |
| 4.3.2 | Мониторинг (Prometheus) | Метрики, здоровье системы |
| 4.3.3 | Нагрузочное тестирование | 500+ SKU |
| 4.3.4 | Документация для пользователя | Руководство, FAQ |

---

## Зависимости между фазами

```
Фаза 0 (DONE) ──→ Фаза 1 (MVP, in progress) ──→ Фаза 2 (Аналитика)
                          │                              │
                          └──→ Фаза 3 (Стратегии) ──→ Фаза 4 (Полировка)
```

Фазы 2 и 3 можно вести параллельно после завершения MVP.

---

## Критический путь

```
Фаза 0 ✅ → Sprint 1.1 ✅ → Sprint 1.2 ✅ → Sprint 1.3 → Sprint 1.5 → Sprint 1.6 (управление ценами)
```

Без сбора данных (1.1) невозможны стратегии. Без стратегий невозможно управление ценами (1.6).

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| WB меняет API | Средняя | Высокое | Абстрактный слой WB API, быстрая адаптация |
| Некорректные данные WB | Высокая | Высокое | Валидация данных, сверка с ЛК, алерты |
| Стратегия работает неверно | Средняя | Высокое | Dry run, undo, логирование, ручной approve |
| Calendar API ограничения | Средняя | Среднее | Двойной источник: API + Excel/CSV импорт |
| Нагрузка на сервер | Низкая | Среднее | Кеширование, Celery для фоновых задач |
| Конкурент меняет медиану | Средняя | Среднее | Антидемпинг-фильтр, ручные исключения |
